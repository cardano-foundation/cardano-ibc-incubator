services:
  entrypoint-init:
    image: ${ENTRYPOINT_CHAIN_IMAGE:-caribic-entrypoint-chain:local}
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: [ "/init-entrypoint.sh" ]
    environment:
      IGNITE_SKIP_PROTO: ${IGNITE_SKIP_PROTO:-1}
      ENTRYPOINT_HOME: ${ENTRYPOINT_HOME:-/root/.entrypoint-data/node}
    volumes:
      - entrypoint-home:/root/.entrypoint-data
    restart: "no"

  entrypoint-node-prod:
    container_name: entrypoint-node-prod
    image: ${ENTRYPOINT_CHAIN_IMAGE:-caribic-entrypoint-chain:local}
    entrypoint: [ "/run-entrypoint.sh" ]
    environment:
      IGNITE_SKIP_PROTO: ${IGNITE_SKIP_PROTO:-1}
      ENTRYPOINT_HOME: ${ENTRYPOINT_HOME:-/root/.entrypoint-data/node}
    volumes:
      - entrypoint-home:/root/.entrypoint-data
    ports:
      - "26657:26657"
      - "26656:26656"
      - "9090:9090"
      - "127.0.0.1:4500:4500"
      - "1317:1317"
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:26657/status | jq -e '.result.sync_info.latest_block_height | tonumber > 0' >/dev/null" ]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 20s
    restart: unless-stopped

volumes:
  entrypoint-home:
